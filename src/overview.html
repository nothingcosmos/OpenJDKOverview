

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OpenJDK HotSpot Client Compiler Overview &mdash; OpenJDK Internals 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="OpenJDK Internals 1.0 documentation" href="../index.html" />
    <link rel="next" title="コンパイル前の動作" href="precompile.html" />
    <link rel="prev" title="Welcome to OpenJDK Internals’s documentation!" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>OpenJDK Internals 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>OpenJDK HotSpot Client Compiler Overview</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="../index.html">Welcome to OpenJDK Internals&#8217;s documentation!</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="precompile.html">コンパイル前の動作</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="openjdk-hotspot-client-compiler-overview">
<h1><em>OpenJDK HotSpot Client Compiler Overview</em><a class="headerlink" href="#openjdk-hotspot-client-compiler-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>タイトル<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><em>OpenJDK HotSpot Client Compiler Overview</em></p>
<p>第4回JVMソースコードリーディングの会</p>
<p>nothingcosmos&lt;<a class="reference external" href="mailto:nothingcosmos&#37;&#52;&#48;gmail&#46;com">nothingcosmos<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;</p>
<p><a class="reference external" href="http://nothingcosmos.blog52.fc2.com/">http://nothingcosmos.blog52.fc2.com/</a></p>
<p><a class="reference external" href="http://nothingcosmos.wiki.fc2.com/">http://nothingcosmos.wiki.fc2.com/</a></p>
</div>
<div class="section" id="id2">
<h2>自己紹介<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>HN:nothingcosmos</p>
<p>元コンパイラ屋のソフトウェアエンジニア 現在は金融系SIer</p>
<p>趣味で、LLVMを読んだり、OpenJDKを読んだり、UNIXv6を読んだりしています。</p>
</div>
<div class="section" id="openjdk">
<h2>OpenJDK キーワード<a class="headerlink" href="#openjdk" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>HotSpotコンパイラ</li>
<li>C1(Client)/C2(Server)コンパイラ</li>
<li>JIT</li>
<li>Adaptive Compilation<ul>
<li>Deoptimize 脱最適化</li>
</ul>
</li>
<li>中間表現/中間言語</li>
</ul>
</div>
<div class="section" id="hotspot1">
<h2>HotSpotの見どころ1<a class="headerlink" href="#hotspot1" title="Permalink to this headline">¶</a></h2>
<p>一般ユーザからみたコンパイラの見どころ</p>
<ul class="simple">
<li>...</li>
</ul>
<p>Scalaユーザからみたコンパイラの見どころ</p>
<ul>
<li><p class="first">Scalaでは細かいオブジェクトをたくさん作るので、
EscapeAnalysisがあると全部レジスタやスタックに乗る</p>
<p>という話を以前kmizuさんに聞いた記憶が...</p>
<p>毎回ヒープに割り付けないので、高速</p>
</li>
</ul>
</div>
<div class="section" id="hotspot2">
<h2>HotSpotの見どころ2<a class="headerlink" href="#hotspot2" title="Permalink to this headline">¶</a></h2>
<p>私個人は、</p>
<ul class="simple">
<li>コンパイラ内部の中間言語構造とアーキテクチャ</li>
<li>大した最適化してないのに速いコードを吐くHotSpot Client Compiler</li>
</ul>
<img alt="../images/performance_comparison_of_JDK.png" src="../images/performance_comparison_of_JDK.png" />
<ul class="simple">
<li>適応的コンパイル Adaptive Compilation<ul>
<li>JITコンパイラ/脱最適化のコントロール</li>
<li>Profiling/Tracingの取得方法と活用方法</li>
</ul>
</li>
<li>HotSpot特有の最適化技術<ul>
<li>EscapeAnalysis/ClassHierarchyAnalysis</li>
<li>複数アーキテクチャへの対応方法</li>
<li>OpenJDK7の最適化のバグ</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="c1-compiler">
<h2>本日紹介するC1 Compiler<a class="headerlink" href="#c1-compiler" title="Permalink to this headline">¶</a></h2>
<img alt="../images/Screenshot-HotSpot.png" src="../images/Screenshot-HotSpot.png" />
<p>OpenJDKのHotSpot Glossary of Termsより抜粋</p>
<div class="highlight-python"><pre>Fast, lightly optimizing bytecode compiler.
Performs some value numbering, inlining, and class analysis.
Uses a simple CFG-oriented SSA "high" IR, a machine-oriented "low" IR,
a linear scan register allocation, and a template-style code generator.</pre>
</div>
<ul class="simple">
<li>ValueNumbering</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>値番号付けというSSA形式を利用した最適化のアルゴリズムの名前.
冗長な式を削除する</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>inlining<ul>
<li>インライン展開</li>
</ul>
</li>
<li>class analysis<ul>
<li>CHA(ClassHierachyAnalysis).
クラス解析 仮想関数呼出の呼び出し先を特定する際に活躍する</li>
</ul>
</li>
<li>CFG-oriented SSA<ul>
<li>CFG ControlFlowGraph</li>
<li>SSA StaticSingleAssignment form</li>
</ul>
</li>
<li>IR<ul>
<li>Intermediate Representation
コンパイラ独自の中間表現</li>
</ul>
</li>
<li>linear scan register allocation<ul>
<li>リニアスキャンというレジスタ割り付けのアルゴリズム</li>
</ul>
</li>
<li>template-style code generator<ul>
<li>asmの生成はあまり頑張らない。LIRからシーケンシャルに生成</li>
</ul>
</li>
</ul>
<img alt="../images/CompilerStructure.png" src="../images/CompilerStructure.png" />
</div>
<div class="section" id="c1">
<h2>C1コンパイラの構成<a class="headerlink" href="#c1" title="Permalink to this headline">¶</a></h2>
<p>hotspot/src/share/vm</p>
<ul class="simple">
<li>c1         &lt;&#8211; C1コンパイラの本体</li>
<li>compiler   &lt;&#8211; コンパイラの抽象クラス</li>
<li>runtime    &lt;&#8211; JVMのruntime部分</li>
</ul>
<p>hotspot/src/share/vm/c1</p>
<p>C1コンパイラ 全体で36kstep</p>
<p>top5</p>
<div class="highlight-python"><pre>c1_LinerScan    7700step  LinerScanでレジスタ割り付け
c1_LIR          4300step  LIR(Low-Level IRの定義)
c1_GraphBuilder 4200step  BytecodeからHIRへの変換
c1_LIRGenerator 3500step  HIRからLIRへの変換
c1_Instruction  3300step  HIR(High-Level IR)の定義</pre>
</div>
<p>vm/c1/*</p>
<div class="highlight-python"><pre>c1_CFGPrinter.cpp           &lt;-- -XX:+PrintCFGToFile オプションを指定時、
c1_CFGPrinter.hpp               中間表現のHIRやLIRをxmlで出力。c1visualizerで解析する
c1_Canonicalizer.cpp        &lt;-- HIRへ変換する際に正規化する
c1_Canonicalizer.hpp            c1_GraphBuilderから呼ばれる
c1_CodeStubs.hpp            &lt;-- LIRやAssemblerで挿入される、JVMのciXX/runtime向けのStub
c1_Compilation.cpp          &lt;-- C1コンパイラのコントローラー Driver???
c1_Compilation.hpp
c1_Compiler.cpp             &lt;-- C1コンパイラの本体
c1_Compiler.hpp
c1_Defs.cpp                 &lt;-- architecture依存の各種定義ファイル レジスタとか
c1_Defs.hpp
c1_FpuStackSim.hpp          &lt;-- architecture依存のFPUStackのシミュレータの定義ファイル
c1_FrameMap.cpp             &lt;-- architecture依存のFrameMapや仮想レジスタやCallingConvension
c1_FrameMap.hpp
c1_GraphBuilder.cpp         &lt;-- BytecodeからHIRへの変換
c1_GraphBuilder.hpp             各種最適化も行う(inlining, devirtualize, canonicalize
c1_IR.cpp                   &lt;-- IRの定義
c1_IR.hpp                       HIR/LIR/BB/各種helperを統合したIRという名のDescripter
c1_Instruction.cpp          &lt;-- HIRの定義や、IRクラスのUtility
c1_Instruction.hpp
c1_InstructionPrinter.cpp   &lt;-- HIRのprinter 見やすいように情報を絞って整形して表示する
c1_InstructionPrinter.hpp
c1_LIR.cpp                  &lt;-- LIRの定義
c1_LIR.hpp
c1_LIRAssembler.cpp         &lt;-- LIRからAsmのemitter兼helper Asmのコード生成
c1_LIRAssembler.hpp
c1_LIRGenerator.cpp         &lt;-- HIRからLIRへの変換
c1_LIRGenerator.hpp             命令選択、レジスタ割り付け、LIRレベルの最適化も行う。
c1_LinearScan.cpp           &lt;-- LinearScanレジスタ割り付け
c1_LinearScan.hpp
c1_MacroAssembler.hpp       &lt;-- architecture依存のAsm出力用マクロ(Assember向けpsuedo code)
c1_Optimizer.cpp            &lt;-- HIR向け各種最適化 Eliminate (const expr|blocks|null checks)
c1_Optimizer.hpp
c1_Runtime1.cpp             &lt;-- C1コンパイラのRuntime JVM本体のruntimeとの橋渡し
c1_Runtime1.hpp
c1_ValueMap.cpp             &lt;-- HIR向け最適化 ValueNumberingの本体
c1_ValueMap.hpp
c1_ValueSet.cpp             &lt;-- HIR向けADT @todo
c1_ValueSet.hpp
c1_ValueStack.cpp           &lt;-- HIR向けADT @todo
c1_ValueStack.hpp
c1_ValueType.cpp            &lt;-- C1コンパイラ内部のIR向け型定義
c1_ValueType.hpp
c1_globals.cpp              &lt;-- C1コンパイラ向けのオプション定義
c1_globals.hpp</pre>
</div>
<p>※  architecture依存と書いたものは、hotspot/src/cpu/XXX/vm の下に本体がいる。</p>
<p>※  architectureは、x86_32/x86_64 sparc zero がある</p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="../index.html">Welcome to OpenJDK Internals&#8217;s documentation!</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="precompile.html">コンパイル前の動作</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2011, nothingcosmos.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
  </body>
</html>