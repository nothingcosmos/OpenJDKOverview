

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>C1コンパイラのHIR最適化 &mdash; OpenJDK Internals 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="OpenJDK Internals 1.0 documentation" href="../index.html" />
    <link rel="next" title="Devirtualization" href="devirtualize.html" />
    <link rel="prev" title="C1コンパイラの内部構造" href="c1_internals.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>OpenJDK Internals 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>C1コンパイラのHIR最適化</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="c1_internals.html">C1コンパイラの内部構造</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="devirtualize.html">Devirtualization</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="c1hir">
<h1>C1コンパイラのHIR最適化<a class="headerlink" href="#c1hir" title="Permalink to this headline">¶</a></h1>
<p>HIR Optimizationは、BytecodeからHIRへ変換終わった後に行う</p>
<p>c1_Compilation.cpp::build_hir()</p>
<div class="highlight-python"><pre>_hir-&gt;optimize();
  IR::optimize()
    opt.eliminate_conditional_expressions();
    opt.eliminate_blocks();
    opt.eliminate_null_checks();</pre>
</div>
<div class="section" id="eliminate-conditional-expressions">
<h2>eliminate_conditional_expressions<a class="headerlink" href="#eliminate-conditional-expressions" title="Permalink to this headline">¶</a></h2>
<p>&#64;todo 時間があればコードを追うこと</p>
<p>CE_Eliminator::block_do()が本体</p>
<div class="highlight-python"><pre>ブロックの終端のifを取得
ifはint型かobject型か判定

true  block
false block
true_instruction
false_instruction

a = (b &gt; c) ? b : c;

BB:
  if ... then BBn false BBm
BBn:
  const n
  goto BBs
BBm:
  const m
  goto BBs
BBs:
  phi [][]</pre>
</div>
<p>CEE Java:</p>
<div class="highlight-python"><pre>public static int CETest(int ret, int n,int  m) {
  ret += (n &lt; m) ? n : m;
  return ret;
}</pre>
</div>
<p>CEE HIR</p>
<div class="highlight-python"><pre>B62:
  i179 = i103 - i76
  i180 = i178 - i151
  v186 = if i179 &gt; i180 then B73 else B72  &lt;-- replace  i186 = ifop (i179 &gt; i180) ixx, iyy;
                                           &lt;-- add      goto B74
B73:                                       &lt;-- delete
  v188 = goto B74                          &lt;-- delete
B72:                                       &lt;-- delete
  v187 = goto B74                          &lt;-- delete
B74:
  i189 = [i179,i180]                       &lt;-- replace
  v190 = goto B70
B70:
  i191 = i151 + i189</pre>
</div>
</div>
<div class="section" id="globalvaluenumbering">
<h2>GlobalValueNumbering<a class="headerlink" href="#globalvaluenumbering" title="Permalink to this headline">¶</a></h2>
<p>&#64;todo 時間があればコードを追うこと</p>
<p>c1_ValueMap.hpp::GlobalValueNumbering(IR* ir)</p>
<div class="highlight-python"><pre>ShortLoopOptimizer short_loop_optimizer(this);

for (int i = 1; i &lt; num_blocks; i++) {
  BlockBegin* block = blocks-&gt;at(i);

  ...

  if (num_preds == 1) {
    // nothing to do here

  } else if (block-&gt;is_set(BlockBegin::linear_scan_loop_header_flag)) {
    // block has incoming backward branches -&gt; try to optimize short loops
    if (!short_loop_optimizer.process(block)) {          &lt;-- ループは特別に処理
      // loop is too complicated, so kill all memory loads because there might be
      // stores to them in the loop
      current_map()-&gt;kill_memory();
    }

  } else {
    // only incoming forward branches that are already processed
    for (int j = 0; j &lt; num_preds; j++) {
      BlockBegin* pred = block-&gt;pred_at(j);
      ValueMap* pred_map = value_map_of(pred);

      if (pred_map != NULL) {
        // propagate killed values of the predecessor to this block
        current_map()-&gt;kill_map(value_map_of(pred));
      } else {
        // kill all memory loads because predecessor not yet processed
        // (this can happen with non-natural loops and OSR-compiles)
        current_map()-&gt;kill_memory();
      }
    }
  }

  if (block-&gt;is_set(BlockBegin::exception_entry_flag)) {
    current_map()-&gt;kill_exception();
  }

  TRACE_VALUE_NUMBERING(tty-&gt;print("value map before processing block: "); current_map()-&gt;print());

  // visit all instructions of this block
  for (Value instr = block-&gt;next(); instr != NULL; instr = instr-&gt;next()) {
    assert(!instr-&gt;has_subst(), "substitution already set");

    // check if instruction kills any values
    instr-&gt;visit(this);

    if (instr-&gt;hash() != 0) {
      Value f = current_map()-&gt;find_insert(instr);  &lt;-- ここがキモ
      if (f != instr) {
        assert(!f-&gt;has_subst(), "can't have a substitution");
        instr-&gt;set_subst(f);
        subst_count++;
      }
    }
  }

  // remember value map for successors
  set_value_map_of(block, current_map());
}</pre>
</div>
</div>
<div class="section" id="escapeanalysis">
<h2>EscapeAnalysis<a class="headerlink" href="#escapeanalysis" title="Permalink to this headline">¶</a></h2>
<p>c1コンパイラからは呼ばれません！！！</p>
<p>wimmerの資料によるとclientからも呼ばれるようだが、昔のJDKもしくはSun JDKだけなのかもしれない。</p>
<p>Serverだとbreakを確認できた。</p>
<p>Sharkだとifdef切ってるけど、多分動かないんだろうと推測</p>
</div>
</div>
<div class="section" id="c1lir">
<h1>C1コンパイラのLIR最適化<a class="headerlink" href="#c1lir" title="Permalink to this headline">¶</a></h1>
<div class="section" id="edgemoveoptimizer">
<h2>EdgeMoveOptimizer<a class="headerlink" href="#edgemoveoptimizer" title="Permalink to this headline">¶</a></h2>
<p>c1_LinearScan.cpp::EdgeMoveOptimizer::optimize(BlockList* code)</p>
<div class="highlight-python"><pre>EdgeMoveOptimizer optimizer = EdgeMoveOptimizer();

// ignore the first block in the list (index 0 is not processed)
for (int i = code-&gt;length() - 1; i &gt;= 1; i--) {
  BlockBegin* block = code-&gt;at(i);

  if (block-&gt;number_of_preds() &gt; 1 &amp;&amp; !block-&gt;is_set(BlockBegin::exception_entry_flag)) {
    optimizer.optimize_moves_at_block_end(block);
  }
  if (block-&gt;number_of_sux() == 2) {
    optimizer.optimize_moves_at_block_begin(block);
  }
}</pre>
</div>
<p>preds &gt; 1 &#8211;&gt; ブロックへのjumpが複数ある場合</p>
<blockquote>
<div><p>CFGの合流ブロックとか、loopのheaderとか</p>
<p>code sink みたいな処理</p>
</div></blockquote>
<p>sux == 2 &#8211;&gt; ブロックからのjumpが複数ある場合</p>
<blockquote>
<div><p>分岐とか、loopのback_edgeとか</p>
<p>code hoist みたいな処理</p>
</div></blockquote>
</div>
<div class="section" id="controlflowoptimizer">
<h2>ControlFlowOptimizer<a class="headerlink" href="#controlflowoptimizer" title="Permalink to this headline">¶</a></h2>
<p>c1_LiearScan.cpp::ControlFlowOptimize::optimize(BlockList* code)</p>
<div class="highlight-python"><pre>ControlFlowOptimizer optimizer = ControlFlowOptimizer();

// push the OSR entry block to the end so that we're not jumping over it.
BlockBegin* osr_entry = code-&gt;at(0)-&gt;end()-&gt;as_Base()-&gt;osr_entry();
if (osr_entry) {
  int index = osr_entry-&gt;linear_scan_number();
  assert(code-&gt;at(index) == osr_entry, "wrong index");
  code-&gt;remove_at(index);
  code-&gt;append(osr_entry);
}

optimizer.reorder_short_loops(code);
optimizer.delete_empty_blocks(code);
optimizer.delete_unnecessary_jumps(code);
optimizer.delete_jumps_to_return(code);</pre>
</div>
<p>reorder_short_loops()</p>
<p>下記のようなケースをpost jumpっぽくする</p>
<p>end_block</p>
<div class="highlight-python"><pre>B4 (V) [35, 50] -&gt; B3 dom B3 sux: B3 pred: B3

__bci__use__tid____instr____________________________________
35   1    i19    31
38   1    i20    i15 * i19
41   2    i21    1
. 41   1    i22    i16 + i21
. 44   1    i23    a11[i16] (C)
. 45   1    i24    i20 + i23
. 47   1    i26    i17 + i21
. 50   0     27    goto B3 (safepoint)</pre>
</div>
<p>header_block</p>
<div class="highlight-python"><pre>B3 (LHbV) [28, 32] -&gt; B5 B4 dom B1 sux: B5 B4 pred: B1 B4

__bci__use__tid____instr____________________________________
. 32   0     18    if i17 &gt;= i12 then B5 else B4</pre>
</div>
<p>delete_unnecessary_jumps()</p>
<blockquote>
<div><p>last_branchが次のブロックへの飛び先だったらdelete</p>
<p>cmp branch1 branch2の場合、branch1が次のブロックへのjumpだったら、
branch1を書き換えて、condの条件を反転 branch2を削除</p>
</div></blockquote>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="c1_internals.html">C1コンパイラの内部構造</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="devirtualize.html">Devirtualization</a>&#160;&#160;»
        </p>

      </div>


    <div class="footer">
        &copy; Copyright 2011, nothingcosmos.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-15223787-2']);
_gaq.push(['_trackPageview']);

(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();

</script>


  </body>
</html>